#!/usr/bin/env python3
import os
import json
import pandas as pd
from pathlib import Path

def parse_vulnerability_reports():
    """Parse all vulnerability reports and extract secrets information."""
    base_dir = Path("vulnerability_reports")
    findings = []
    
    # Walk through all project directories
    for project_dir in base_dir.iterdir():
        if not project_dir.is_dir():
            continue
            
        project_name = project_dir.name
        
        # Look for semgrep reports which contain the secrets
        semgrep_file = project_dir / f"{project_name}_semgrep.json"
        
        if semgrep_file.exists():
            try:
                with open(semgrep_file, 'r') as f:
                    data = json.load(f)
                    
                # Extract findings from semgrep report
                for result in data.get('results', []):
                    findings.append({
                        'Project': project_name,
                        'File': result.get('path', 'N/A'),
                        'Line': result.get('start', {}).get('line', 'N/A'),
                        'Secret Type': result.get('check_id', 'N/A'),
                        'Match': result.get('extra', {}).get('message', 'N/A')[:100] + '...' if result.get('extra', {}).get('message') else 'N/A',
                    })
                        
            except (json.JSONDecodeError, Exception) as e:
                print(f"Error processing {semgrep_file}: {e}")
    
    return findings

def generate_secrets_table(findings):
    """Generate a markdown table from the findings."""
    if not findings:
        return "No secrets found in the vulnerability reports."
    
    # Create a DataFrame for better formatting
    df = pd.DataFrame(findings)
    
    # Generate markdown table
    markdown = "# Secrets Found in Codebase\n\n"
    markdown += "| Project | File | Line | Secret Type | Match Preview |\n"
    markdown += "|---------|------|------|-------------|---------------|\n"
    
    for _, row in df.iterrows():
        markdown += f"| {row['Project']} | {row['File']} | {row['Line']} | {row['Secret Type']} | {row['Match']} |\n"
    
    # Add summary
    markdown += f"\n## Summary\n"
    markdown += f"- Total secrets found: {len(findings)}\n"
    markdown += f"- Projects affected: {df['Project'].nunique()}\n"
    
    return markdown

if __name__ == "__main__":
    print("Analyzing vulnerability reports...")
    findings = parse_vulnerability_reports()
    
    if findings:
        output_file = "secrets_findings.md"
        with open(output_file, 'w') as f:
            f.write(generate_secrets_table(findings))
        print(f"Report generated: {output_file}")
    else:
        print("No secrets found in the vulnerability reports.")
